# low-latency-lab — снижение задержки при работе через Tailscale + ThinLinc

> Набор инструкций и твиков для улучшения отзывчивости удалённого рабочего стола.

---

### 1. Убедитесь, что Tailscale использует **прямое соединение,** а не через **DERP**

Tailscale по умолчанию использует **DERP** (Relay серверы), чтобы временно связать два узла, пока не будет найден прямой маршрут (P2P). Если P2P-соединение не удаётся установить (из-за строгого NAT, блокировки UDP и т.д.), соединение остаётся через DERP, что значительно увеличивает задержку и нестабильность.

```bash
tailscale status         # должно быть "direct", а не "relay"
tailscale ping <host>    # проверка доступности узла
tailscale netcheck       # оценка NAT, UDP, DERP, P2P
```

#### Поддержка P2P соединения

- Tailscale **всегда стремится** установить прямой UDP-туннель между узлами.
- **DERP** подключение используется только когда прямой маршрут невозможен.
- Для поддержки P2P:
  - Откройте или пробросьте **UDP порт 41641** на публичном IP
  - Включите в роутере **UPnP** или **NAT-PMP**

---

### 2. Настройка ThinLinc для более плавной работы

В клиенте ThinLinc (вкладка **Optimization**) можно настроить поведение VNC-протокола под качество сети:

- **Auto Select** — режим по умолчанию:
  - ThinLinc автоматически выбирает кодек и параметры в зависимости от текущей пропускной способности и задержки.

- **Preferred encoding** — ручной выбор кодека:
  - `Tight` — сочетает zlib и JPEG, даёт минимальный трафик, но высокую нагрузку на CPU. Рекомендуется для слабых сетей.
  - `Hextile`, `ZRLE`, `Raw` — передают больше данных, но быстрее работают на хорошей сети.

- **Compression level (0–9)** — степень общего сжатия (zlib):
  - `2–3` — на хорошей сети
  - `7–9` — при медленном соединении и высокой задержке

- **JPEG compression** — степень JPEG-сжатия цветных областей:
  - `2–3` — на хорошей сети
  - `7–9` — при медленном соединении и высокой задержке

- **Color level** — глубина цвета:
  - `Full` — высокая детализация, большой объём данных
  - `Medium` или `Low` — снижают нагрузку на канал, подходят для медленных сетей

- **SSH Compression** — по умолчанию выключена:
  - Не рекомендуется включать, т.к. графика уже эффективно сжимается средствами ThinLinc.
  - Включайте только в крайнем случае при очень ограниченном канале и высоком latency.

---

### 3. Настройка рабочего стола XFCE для более плавной работы

1. **Отключите визуальные эффекты и анимации**:

   - `Settings → Window Manager Tweaks → Эффекты → отключить`

2. **Упростите тему оформления**:

   - `Settings → Desktop → Цвет: сплошной цвет, чёрный; Стиль: отсутствует`

---

### 4. Дополнительное

#### Exit/Relay-узлы в Tailscale

- Можно задать **exit-node** (узел, через который будет идти весь трафик) ближе к клиенту или серверу:
  - Например, это виртуалка с Tailscale в своей стране, через которую подключение происходит на рабочий сервер, тем самым снижает общую задержку.
  - Используйте `tailscale up --exit-node=<node>` на клиенте

#### Сетевое оборудование

- Сетевое оборудование: при возможности улучшите сам канал: проверьте качество кабеля/оптики, замените Wi‑Fi на провод (Ethernet).
- Включите приоритезацию UDP (QoS) на роутере при возможности.
